name: build
on:
  workflow_dispatch:

jobs:
  build-linux:
    name: build (Linux x64)
    runs-on: ubuntu-latest
    env:
      BIN_NAME: jorik-cli
      TARGET: x86_64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-${{ env.TARGET }}
      - run: cargo build --release --target ${{ env.TARGET }}
      - name: Package
        shell: bash
        run: |
          OUT="target/${{ env.TARGET }}/release/${{ env.BIN_NAME }}"
          mkdir -p dist
          cp "$OUT" "dist/jorik"
          tar -C dist -czf "dist/jorik-${{ env.TARGET }}.tar.gz" "jorik"
      - uses: christopherhx/gitea-upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ env.TARGET }}
          path: dist/*

  build-windows:
    name: build (Windows x64)
    runs-on: windows-latest
    env:
      BIN_NAME: jorik-cli
      TARGET: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4
      - name: Add cargo bin to PATH
        shell: pwsh
        run: |
          $candidates = @(
            "$env:USERPROFILE\.cargo\bin",
            "C:\Users\Docker\.cargo\bin",
            "C:\Users\Docker\.rustup\toolchains\stable-x86_64-pc-windows-msvc\bin",
            "C:\Program Files\Rust stable MSVC 1.0\bin",
            "C:\Program Files\Rust stable GNU 1.0\bin",
            "C:\Rust\.cargo\bin"
          )
          foreach ($p in $candidates) {
            if (Test-Path (Join-Path $p "cargo.exe")) {
              Add-Content $env:GITHUB_PATH $p
              break
            }
          }

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-${{ env.TARGET }}

      - name: Get version
        shell: pwsh
        run: |
          $versionLine = Get-Content Cargo.toml | Where-Object { $_ -match '^version' } | Select-Object -First 1
          $version = ($versionLine -split '"')[1]
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build
        shell: pwsh
        run: |
          $env:PATH = "C:\Users\Docker\.cargo\bin;C:\Users\Docker\.rustup\toolchains\stable-x86_64-pc-windows-msvc\bin;$env:USERPROFILE\.cargo\bin;$env:PATH"
          if (Get-Command rustup -ErrorAction SilentlyContinue) { rustup default stable }
          cargo build --release --target ${{ env.TARGET }}

      - name: Package binary (zip)
        shell: pwsh
        run: |
          $src = "target\${{ env.TARGET }}\release\jorik-cli.exe"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $renamed = "dist\jorik.exe"
          Copy-Item $src $renamed -Force
          Compress-Archive -Path $renamed -DestinationPath "dist\jorik-${{ env.TARGET }}.zip" -Force

      - name: Build installer
        shell: pwsh
        run: |
          Copy-Item "target\${{ env.TARGET }}\release\jorik-cli.exe" "target\${{ env.TARGET }}\release\jorik.exe" -Force
          iscc /DMyAppVersion=${{ env.VERSION }} /DMyTarget=${{ env.TARGET }} installer\jorik-cli.iss

      - uses: christopherhx/gitea-upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ env.TARGET }}
          path: dist/*

  release:
    needs:
      - build-linux
      - build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          VERSION=$(grep "^version" Cargo.toml | head -n 1 | cut -d '"' -f 2)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - uses: christopherhx/gitea-download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - uses: akkuman/gitea-release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release v${{ env.VERSION }}
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/*setup.exe
